---
# Repository-specific PipelineRun configuration
# Customize the parameters below for your specific repository
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  name: e2e-pipeline-run
spec:
  params:
    # Git repository configuration
    - name: branch-name
      value: btweed/e2e
    - name: repo-url
      value: https://github.com/RedHatInsights/learning-resources.git

    # Application artifact to test
    - name: SOURCE_ARTIFACT
      # Use latest prod image or specify a PR/dev image
      # value: quay.io/redhat-services-prod/hcc-platex-services-tenant/learning-resources:latest
      value: quay.io/redhat-user-workloads/hcc-platex-services-tenant/learning-resources/learning-resources:on-pr-c1a61630f80215241cf5ae39e2fd1d101de344ad

    # Test credentials (substituted from environment variables)
    - name: E2E_USER
      value: "${E2E_USER}"
    - name: E2E_PASSWORD
      value: "${E2E_PASSWORD}"
    - name: e2e_proxy
      value: "${E2E_PROXY_URL}"
    - name: STAGE_ACTUAL_HOSTNAME
      value: "${STAGE_ACTUAL_HOSTNAME}"

    # Custom proxy routes for this application (Caddy directives)
    - name: proxy-routes-json
      value: |
        handle /index.html {
            reverse_proxy 127.0.0.1:9912
        }

        handle /apps/chrome* {
            reverse_proxy 127.0.0.1:9912
        }

        handle /apps/learning-resources* {
            reverse_proxy 127.0.0.1:8000
        }

        handle /settings/learning-resources* {
            reverse_proxy 127.0.0.1:8000
        }

        handle /openshift/learning-resources* {
            reverse_proxy 127.0.0.1:8000
        }

        handle /ansible/learning-resources* {
            reverse_proxy 127.0.0.1:8000
        }

        handle /insights/learning-resources* {
            reverse_proxy 127.0.0.1:8000
        }

        handle /edge/learning-resources* {
            reverse_proxy 127.0.0.1:8000
        }

        handle /iam/learning-resources* {
            reverse_proxy 127.0.0.1:8000
        }

        handle /learning-resources* {
            reverse_proxy 127.0.0.1:8000
        }

        handle /learning-resources/creator* {
            reverse_proxy 127.0.0.1:8000
        }

    # Optional: Override the default test script
    # - name: e2e-tests-script
    #   value: |
    #     echo "Running custom test script"
    #     cd /workspace/output
    #     npm install
    #     npx playwright test playwright/*

  # Workspace configuration
  workspaces:
    - name: shared-code-workspace
      volumeClaimTemplate:
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 2Gi

  # Reference to the shared pipeline definition
  pipelineRef:
    name: e2e-pipeline

  # Task-specific runtime configuration
  taskRunSpecs:
    - pipelineTaskName: e2e-test-run
      podTemplate:
        # Override /etc/hosts to redirect stage.foo.redhat.com to localhost
        hostAliases:
          - ip: "::1"
            hostnames:
              - "stage.foo.redhat.com"
          - ip: "127.0.0.1"
            hostnames:
              - "stage.foo.redhat.com"
